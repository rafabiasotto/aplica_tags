# SCRIPT POWERSHELL PARA APLICAR TAGS E POLICY ASSIGNMENTS COM AZ CLI

# Vari√°vel que armazena o caminho do execut√°vel az
$AZ = "az"

# Fun√ß√£o para executar comandos e capturar erros de forma elegante
function Invoke-Az {
    param(
        [Parameter(Mandatory = $true)]
        [string[]]$Command
    )

    $CommandString = "$AZ " + ($Command -join " ")
    Write-Host "Executando: $CommandString" -ForegroundColor DarkGray

    & $AZ @Command
    $ExitCode = $LASTEXITCODE

    if ($ExitCode -ne 0) {
        Write-Error "‚ùå ERRO FATAL para comando: $CommandString (ExitCode = $ExitCode)"
        return $null
    }

    return $true
}

# ------------------------------------------------------------

## 1. Sele√ß√£o da Assinatura

Write-Host "`nüîç Lendo assinaturas do tenant...`n" -ForegroundColor Cyan

try {
    $SubsOutput = & $AZ account list | Out-String
    if (-not $SubsOutput) { throw "Falha cr√≠tica ao listar assinaturas." }
    $Subs = $SubsOutput | ConvertFrom-Json
} catch {
    Write-Error "‚ùå ERRO ao ler assinaturas. Verifique o AZ CLI."
    exit 1
}

Write-Host "Selecione uma assinatura:"
$counter = 1
$Subs | ForEach-Object {
    Write-Host "$counter. $($_.name) ($($_.id))"
    $counter++
}

[int]$Selection = Read-Host "`nDigite o n√∫mero da assinatura"
if ($Selection -lt 1 -or $Selection -gt $Subs.Count) {
    Write-Error "‚ùå Sele√ß√£o inv√°lida."
    exit 1
}

$Subscription = $Subs[$Selection - 1]
$SubscriptionId = $Subscription.id
$SubscriptionName = $Subscription.name

Write-Host "`nüüß Assinatura selecionada: **$SubscriptionName** ($SubscriptionId)`n" -ForegroundColor Yellow

& $AZ account set --subscription $SubscriptionId

# -----------------------------------------------------------

## 2. Sele√ß√£o do Resource Group

Write-Host "üîç Lendo Resource Groups...`n" -ForegroundColor Cyan

try {
    $RgsOutput = & $AZ group list | Out-String
    if (-not $RgsOutput) { throw "Falha cr√≠tica ao listar RGs." }
    $Rgs = $RgsOutput | ConvertFrom-Json
} catch {
    Write-Error "‚ùå Falha ao ler RGs."
    exit 1
}

Write-Host "Selecione um Resource Group:"
$counter = 1
$Rgs | ForEach-Object {
    Write-Host "$counter. $($_.name) (Local: $($_.location))"
    $counter++
}

[int]$RgSelection = Read-Host "`nDigite o n√∫mero do RG"
if ($RgSelection -lt 1 -or $RgSelection -gt $Rgs.Count) {
    Write-Error "‚ùå Sele√ß√£o inv√°lida."
    exit 1
}

$Rg = $Rgs[$RgSelection - 1]
$RgName = $Rg.name
$RgLocation = $Rg.location
$Scope = "/subscriptions/$SubscriptionId/resourceGroups/$RgName"

Write-Host "`nüü¶ RG selecionado: **$RgName** (Localiza√ß√£o: $RgLocation)`n" -ForegroundColor Blue

# -----------------------------------------------------------

## 3. Valores das Tags ‚Äì (ATUALIZADO)

$TagEnvironment  = Read-Host "Valor da tag 'environment'"
$TagCostCenter   = Read-Host "Valor da tag 'cost-center'"
$TagApplication  = Read-Host "Valor da tag 'application'"
$TagOwner        = Read-Host "Valor da tag 'cost-owner'"
 
$Tags = @{
    "environment" = $TagEnvironment
    "cost-center" = $TagCostCenter
    "application" = $TagApplication
    "cost-owner"  = $TagOwner
}

Write-Host "`nüöÄ Aplicando tags no Resource Group...`n" -ForegroundColor Green

$Tags.GetEnumerator() | ForEach-Object {
    Write-Host "‚û°Ô∏è Aplicando tag $($_.Key)=$($_.Value)" -ForegroundColor DarkGreen
    & $AZ group update -n $RgName --set "tags.$($_.Key)=$($_.Value)" | Out-Null
}

# -----------------------------------------------------------

## 4. Policy Assignments e Remedia√ß√µes

Write-Host "`nüèó Criando assignments e remedia√ß√µes...`n" -ForegroundColor Yellow

$PolicyId = "cd3aa116-8754-49c9-a813-ad46512ece54"
$PolicyDisplayName = "Inherit a tag from the resource group if missing"

$Tags.GetEnumerator() | ForEach-Object {

    $Key = $_.Key
    
    # AJUSTE DE LIMITE DE CARACTERE:
    # Usando prefixo curto e limitando o nome do RG para garantir que n√£o passe de 64 caracteres.
    $ShortRg = if ($RgName.Length -gt 25) { $RgName.Substring(0,25) } else { $RgName }
    $AssignmentName = "inh-$Key-$ShortRg"
    $RemediationName = "rem-$Key-$ShortRg"

    Write-Host "`n‚û°Ô∏è Criando assignment '$AssignmentName'..." -ForegroundColor DarkYellow

    # JSON tempor√°rio
    $TempFilePath = Join-Path $PSScriptRoot "$AssignmentName.parameters.json"

    $ParamsObject = @{
        tagName = @{ value = $Key }
    }

    $ParamsObject | ConvertTo-Json -Depth 5 -Compress | Out-File $TempFilePath -Encoding UTF8

    # CRIA√á√ÉO DO ASSIGNMENT
    $AssignmentOutput = & $AZ policy assignment create `
        --name $AssignmentName `
        --display-name "$PolicyDisplayName - $Key" `
        --scope $Scope `
        --policy $PolicyId `
        --params $TempFilePath `
        --assign-identity `
        --identity-scope $Scope `
        --role Contributor `
        --location $RgLocation | Out-String

    Remove-Item $TempFilePath -Force -ErrorAction SilentlyContinue

    if ($AssignmentOutput) {
        Write-Host "‚úÖ Assignment criado com sucesso." -ForegroundColor Green

        Write-Host "‚û°Ô∏è Criando remedia√ß√£o para '$Key'..." -ForegroundColor DarkGreen

        & $AZ policy remediation create `
            --name $RemediationName `
            --resource-group $RgName `
            --policy-assignment $AssignmentName `
            --resource-discovery-mode ReEvaluateCompliance | Out-Null

        Write-Host "‚úÖ Remedia√ß√£o criada." -ForegroundColor Green

    } else {
        Write-Error "‚ùå Falha ao criar assignment '$AssignmentName'."
    }
}

Write-Host "`n`n‚úÖ FINALIZADO! Tags aplicadas, assignments criados e remedia√ß√µes iniciadas.`n" -ForegroundColor Green
